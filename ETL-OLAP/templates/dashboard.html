<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard KPIs OLAP - Sistema de Proyectos</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #3498db;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--primary-color), #34495e);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .kpi-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            margin-bottom: 20px;
        }
        
        .kpi-card:hover {
            transform: translateY(-5px);
        }
        
        .kpi-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0;
        }
        
        .kpi-label {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .kpi-description {
            font-size: 0.8rem;
            color: #8b949e;
        }
        
        .status-good { color: var(--success-color); }
        .status-regular { color: var(--warning-color); }
        .status-bad { color: var(--danger-color); }
        
        .bg-good { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .bg-regular { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .bg-bad { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        
        .alert-item {
            border-left: 4px solid;
            margin-bottom: 10px;
        }
        
        .alert-alta { border-left-color: var(--danger-color); }
        .alert-media { border-left-color: var(--warning-color); }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .tab-content {
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .nav-tabs .nav-link {
            border: none;
            border-radius: 25px;
            margin-right: 10px;
            padding: 10px 20px;
        }
        
        .nav-tabs .nav-link.active {
            background: var(--primary-color);
            color: white;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-chart-line"></i> Dashboard KPIs OLAP
            </span>
            <span class="navbar-text" id="last-update">
                Cargando...
            </span>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        
        <!-- KPIs Principales -->
        <div class="row mb-4">
            <div class="col-12">
                <h2><i class="fas fa-tachometer-alt"></i> KPIs Principales</h2>
                <div id="kpis-loading" class="loading">
                    <div class="spinner"></div>
                </div>
                <div id="kpis-container" class="row" style="display: none;">
                    <!-- KPIs se cargarán aquí dinámicamente -->
                </div>
            </div>
        </div>

        <!-- Alertas -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="kpi-card p-3">
                    <h4><i class="fas fa-exclamation-triangle text-warning"></i> Alertas de KPIs</h4>
                    <div id="alertas-container">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs para análisis detallado -->
        <div class="row">
            <div class="col-12">
                <ul class="nav nav-tabs" id="analysis-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="trends-tab" data-bs-toggle="tab" data-bs-target="#trends" type="button" role="tab">
                            <i class="fas fa-chart-area"></i> Tendencias
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="clients-tab" data-bs-toggle="tab" data-bs-target="#clients" type="button" role="tab">
                            <i class="fas fa-users"></i> Por Cliente
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="cubes-tab" data-bs-toggle="tab" data-bs-target="#cubes" type="button" role="tab">
                            <i class="fas fa-cube"></i> Cubos OLAP
                        </button>
                    </li>
                </ul>
                <div class="tab-content" id="analysis-content">
                    
                    <!-- Tab Tendencias -->
                    <div class="tab-pane fade show active" id="trends" role="tabpanel">
                        <h4>Análisis de Tendencias Temporales</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="chart-container">
                                    <canvas id="trendsChart"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="chart-container">
                                    <canvas id="kpiEvolutionChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab Clientes -->
                    <div class="tab-pane fade" id="clients" role="tabpanel">
                        <h4>KPIs por Cliente</h4>
                        <div id="clients-loading" class="loading">
                            <div class="spinner"></div>
                        </div>
                        <div id="clients-container" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-striped" id="clients-table">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Cliente</th>
                                            <th>Cumplimiento Presupuesto</th>
                                            <th>Desviación</th>
                                            <th>Proyectos a Tiempo</th>
                                            <th>Total Proyectos</th>
                                            <th>Presupuesto Total</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab Cubos OLAP -->
                    <div class="tab-pane fade" id="cubes" role="tabpanel">
                        <h4>Cubos OLAP</h4>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>Cubo Principal</h5>
                                    </div>
                                    <div class="card-body">
                                        <button class="btn btn-primary" onclick="loadCube('principales')">
                                            <i class="fas fa-download"></i> Cargar Datos
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>Cubo Temporal</h5>
                                    </div>
                                    <div class="card-body">
                                        <button class="btn btn-primary" onclick="loadCube('temporal')">
                                            <i class="fas fa-download"></i> Cargar Datos
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>Cubo por Categorías</h5>
                                    </div>
                                    <div class="card-body">
                                        <button class="btn btn-primary" onclick="loadCube('categorias')">
                                            <i class="fas fa-download"></i> Cargar Datos
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="cube-data" class="mt-4" style="display: none;">
                            <h5 id="cube-title"></h5>
                            <div class="table-responsive">
                                <table class="table table-sm" id="cube-table">
                                    <thead class="table-dark"></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Variables globales
        let kpisData = {};
        let charts = {};
        
        // Cargar datos al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            loadKPIs();
            loadAlertas();
            loadTendencias();
            loadClientes();
            
            // Actualizar cada 5 minutos
            setInterval(() => {
                loadKPIs();
                loadAlertas();
            }, 300000);
        });
        
        // Cargar KPIs principales
        async function loadKPIs() {
            try {
                const response = await fetch('/api/kpis');
                const data = await response.json();
                
                if (data.success) {
                    kpisData = data.kpis;
                    renderKPIs(data.kpis);
                    document.getElementById('last-update').textContent = 
                        'Última actualización: ' + new Date(data.timestamp).toLocaleString();
                }
            } catch (error) {
                console.error('Error cargando KPIs:', error);
            }
        }
        
        // Renderizar KPIs
        function renderKPIs(kpis) {
            const container = document.getElementById('kpis-container');
            const loading = document.getElementById('kpis-loading');
            
            container.innerHTML = '';
            
            Object.entries(kpis).forEach(([key, kpi]) => {
                const col = document.createElement('div');
                col.className = 'col-lg-3 col-md-4 col-sm-6';
                
                const statusClass = `status-${kpi.estado}`;
                const bgClass = `bg-${kpi.estado}`;
                
                col.innerHTML = `
                    <div class="kpi-card p-4 text-center ${bgClass} text-white">
                        <div class="kpi-label">${kpi.descripcion}</div>
                        <p class="kpi-value ${statusClass}">${kpi.valor}${kpi.unidad}</p>
                        <div class="kpi-description">
                            Objetivo: ${kpi.objetivo}${kpi.unidad}
                        </div>
                        <div class="mt-2">
                            <i class="fas ${getKPIIcon(kpi.estado)} fa-2x"></i>
                        </div>
                    </div>
                `;
                
                container.appendChild(col);
            });
            
            loading.style.display = 'none';
            container.style.display = 'flex';
        }
        
        // Obtener icono según estado del KPI
        function getKPIIcon(estado) {
            switch(estado) {
                case 'bueno': return 'fa-check-circle';
                case 'regular': return 'fa-exclamation-circle';
                case 'malo': return 'fa-times-circle';
                default: return 'fa-question-circle';
            }
        }
        
        // Cargar alertas
        async function loadAlertas() {
            try {
                const response = await fetch('/api/alertas');
                const data = await response.json();
                
                if (data.success) {
                    renderAlertas(data.alertas);
                }
            } catch (error) {
                console.error('Error cargando alertas:', error);
            }
        }
        
        // Renderizar alertas
        function renderAlertas(alertas) {
            const container = document.getElementById('alertas-container');
            
            if (alertas.length === 0) {
                container.innerHTML = '<div class="alert alert-success"><i class="fas fa-check"></i> Todos los KPIs están dentro de los umbrales aceptables</div>';
                return;
            }
            
            container.innerHTML = alertas.map(alerta => `
                <div class="alert alert-${alerta.severidad === 'alta' ? 'danger' : 'warning'} alert-item alert-${alerta.severidad}">
                    <strong>${alerta.kpi.replace('_', ' ').toUpperCase()}</strong>: 
                    ${alerta.valor}${alerta.unidad} (Objetivo: ${alerta.objetivo}${alerta.unidad})
                    <br>
                    <small>${alerta.recomendacion}</small>
                </div>
            `).join('');
        }
        
        // Cargar tendencias
        async function loadTendencias() {
            try {
                const response = await fetch('/api/tendencias');
                const data = await response.json();
                
                if (data.success && data.tendencias.anuales) {
                    renderTrendsChart(data.tendencias.anuales);
                }
            } catch (error) {
                console.error('Error cargando tendencias:', error);
            }
        }
        
        // Renderizar gráfico de tendencias
        function renderTrendsChart(data) {
            const ctx = document.getElementById('trendsChart').getContext('2d');
            
            const years = Object.keys(data);
            const cumplimiento = years.map(year => data[year].cumplimiento_presupuesto_individual * 100);
            const proyectos = years.map(year => data[year].ID_Proyecto);
            
            if (charts.trends) {
                charts.trends.destroy();
            }
            
            charts.trends = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Cumplimiento Presupuesto (%)',
                        data: cumplimiento,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Cantidad Proyectos',
                        data: proyectos,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        yAxisID: 'y1',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }
        
        // Cargar datos de clientes
        async function loadClientes() {
            try {
                const response = await fetch('/api/kpis/cliente');
                const data = await response.json();
                
                if (data.success) {
                    renderClientesTable(data.data);
                }
            } catch (error) {
                console.error('Error cargando clientes:', error);
            }
        }
        
        // Renderizar tabla de clientes
        function renderClientesTable(clientes) {
            const tbody = document.querySelector('#clients-table tbody');
            const loading = document.getElementById('clients-loading');
            const container = document.getElementById('clients-container');
            
            tbody.innerHTML = clientes.map(cliente => `
                <tr>
                    <td>${cliente.cliente}</td>
                    <td>
                        <span class="badge ${cliente.cumplimiento_presupuesto >= 90 ? 'bg-success' : 
                                           cliente.cumplimiento_presupuesto >= 85 ? 'bg-warning' : 'bg-danger'}">
                            ${cliente.cumplimiento_presupuesto}%
                        </span>
                    </td>
                    <td>${cliente.desviacion_presupuestal}%</td>
                    <td>${cliente.proyectos_a_tiempo}%</td>
                    <td>${cliente.total_proyectos}</td>
                    <td>$${cliente.presupuesto_total.toLocaleString()}</td>
                </tr>
            `).join('');
            
            loading.style.display = 'none';
            container.style.display = 'block';
        }
        
        // Cargar cubo OLAP específico
        async function loadCube(tipo) {
            try {
                const response = await fetch(`/api/cubo/${tipo}`);
                const data = await response.json();
                
                if (data.success) {
                    renderCubeTable(data);
                }
            } catch (error) {
                console.error(`Error cargando cubo ${tipo}:`, error);
            }
        }
        
        // Renderizar tabla de cubo
        function renderCubeTable(cubeData) {
            const table = document.getElementById('cube-table');
            const title = document.getElementById('cube-title');
            const container = document.getElementById('cube-data');
            
            title.textContent = `Cubo OLAP: ${cubeData.cubo}`;
            
            // Crear encabezados
            const thead = table.querySelector('thead');
            thead.innerHTML = `
                <tr>
                    <th>Dimensión</th>
                    ${cubeData.columns.map(col => `<th>${col}</th>`).join('')}
                </tr>
            `;
            
            // Crear filas (mostrar solo las primeras 20)
            const tbody = table.querySelector('tbody');
            const limitedData = cubeData.data.slice(0, 20);
            
            tbody.innerHTML = limitedData.map(row => `
                <tr>
                    <td><strong>${Array.isArray(row.index) ? row.index.join(' - ') : row.index}</strong></td>
                    ${cubeData.columns.map(col => `<td>${row[col] !== null ? (typeof row[col] === 'number' ? row[col].toFixed(2) : row[col]) : '-'}</td>`).join('')}
                </tr>
            `).join('');
            
            container.style.display = 'block';
        }
    </script>
</body>
</html>